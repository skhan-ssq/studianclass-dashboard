<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Study Progress & Cert (ADMIN) - Enhanced</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>

    /* 달력 그리드 고정 */
    .calendar-day.other-month {
      background: #f9fafb !important;
      color: #9ca3af !important;
    }
    .calendar-day.out-of-range {
      background: #f3f4f6 !important;
      color: #9ca3af !important;
    }
    .calendar-day.out-of-range .calendar-day-content {
      opacity: 0.3;
    }
    .calendar-day.today {
      background: #fef3c7 !important;
      border-color: #f59e0b !important;
    }
    #calendarDays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
/* 달력 스타일 - 완전 교체 */
    .calendar-container {
      margin-top: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    .calendar-header {
      background: #f9fafb;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #e5e7eb;
      gap: 30px; /* 버튼과 제목 간격 */
    }
    .calendar-nav-btn {
      background: none;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .calendar-nav-btn:hover {
      background: #f3f4f6;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: 600;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-weekdays {
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-weekday {
      padding: 12px 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      border-right: 1px solid #e5e7eb;
    }
    .calendar-weekday:last-child {
      border-right: none;
    }
    #calendarDays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-day {
      min-height: 80px;
      border: 1px solid #f3f4f6;
      border-top: none;
      padding: 6px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      position: relative;
      background: #fff;
      font-size: 12px;
    }
    .calendar-day.other-month {
      background: #f9fafb;
      color: #9ca3af;
    }
    .calendar-day.out-of-range {
      background: #f3f4f6;
      color: #9ca3af;
    }
    .calendar-day.out-of-range .calendar-day-content {
      opacity: 0.3;
    }
    .calendar-day.today {
      background: #fef3c7;
      border-color: #f59e0b;
    }
    .calendar-day-number {
      font-size: 14px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .calendar-day-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 10px;
      width: 100%;
    }
    .cert-indicator {
      background: #10b981;
      color: white;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 500;
      align-self: flex-start;
    }
    .progress-indicator {
      background: #3b82f6;
      color: white;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 500;
      align-self: flex-start;
    }
    .calendar-legend {
      padding: 16px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }    
    
    /* 전체 조회 탭 스타일 */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
    }
    .stat-label {
      color: #6b7280;
      font-size: 14px;
      margin-top: 4px;
    }
    .search-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-input {
      padding: 6px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      min-width: 150px;
    }
    .export-btn {
      padding: 6px 12px;
      background: #059669;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .settings-panel {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .settings-panel input {
      width: 60px;
      padding: 4px 6px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
    }
    .chart-container {
      height: 250px;
      margin-top: 10px;
    }
    .tab-content-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .filter-section {
      display: none;
    }
    .filter-section.active {
      display: block;
    }
    .section-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .section-tab {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .section-tab.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
  </style>
</head>
<body>
  <div id="authOverlay" role="dialog" aria-modal="true" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;">
    <h2>ADMIN 코드 입력</h2>
    <input id="authInput" type="password" placeholder="코드 입력" style="padding:8px;font-size:16px;">
    <button id="authBtn" type="button" style="margin-top:10px;padding:6px 12px;">확인</button>
    <p id="authMsg" style="color:red;display:none;">코드가 올바르지 않습니다.</p>
  </div>

  <div class="wrap">
    <h1>Study Progress & Certification (ADMIN)</h1>
    
    <div id="dataSource" class="muted" style="display:flex;align-items:center;justify-content:space-between;">
      <span>주 1회 업데이트</span>
      <span id="updateTime"></span>
    </div>
    <div id="loadError" class="muted" style="display:none;margin:8px 0;"></div>

    <!-- 탭 네비게이션 -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="all">전체 조회</button>
      <button class="tab-btn" data-tab="personal">개인 조회</button>
    </div>

    <!-- 전체 조회 탭 -->
    <div id="tabAll">
      <!-- 차트 섹션 -->
      <div class="dashboard-grid">
        <div class="stat-card">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span class="stat-label">최소 인증 횟수:</span>
            <input type="number" id="minCertCount" value="3" min="1" max="20" style="width: 60px; padding: 4px 6px; border: 1px solid #d1d5db; border-radius: 4px;">
          </div>
          <div class="chart-container">
            <canvas id="weeklyCertChart"></canvas>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">진도율 상승 고객 수 (최근 4주)</div>
          <div class="chart-container">
            <canvas id="weeklyProgressChart"></canvas>
          </div>
        </div>
      </div>

      <!-- 과정별/단톡방별 조회 섹션 -->
      <div class="card">
        <div class="section-tabs">
          <button class="section-tab active" data-section="course">과정별 조회</button>
          <button class="section-tab" data-section="room">단톡방 조회</button>
        </div>

        <!-- 과정별 조회 -->
        <div id="sectionCourse" class="filter-section active">
          <div class="tab-content-filters">
            <select id="allCourseSelect" class="filter-input">
              <option value="">전체 과정</option>
            </select>
            <button id="applyCourseFilter" class="btn primary">조회</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4>인증 고객 (4주 평균 기준)</h4>
              <div style="max-height: 400px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr><th>단톡방</th><th>고객명</th><th>평균 인증수</th></tr>
                  </thead>
                  <tbody id="courseCertTable"></tbody>
                </table>
              </div>
            </div>
            <div>
              <h4>진도율 상승 고객 (4주 기준)</h4>
              <div style="max-height: 400px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr><th>단톡방</th><th>고객명</th><th>현재 진도율</th><th>상승폭</th></tr>
                  </thead>
                  <tbody id="courseProgressTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- 단톡방별 조회 -->
        <div id="sectionRoom" class="filter-section">
          <div class="tab-content-filters">
            <select id="allCourseSelectForRoom" class="filter-input">
              <option value="">과정 선택</option>
            </select>
            <select id="allRoomSelect" class="filter-input">
              <option value="">단톡방 선택</option>
            </select>
            <button id="applyRoomFilter" class="btn primary">조회</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h4>인증 고객 (4주 평균 기준)</h4>
              <div style="max-height: 400px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr><th>고객명</th><th>평균 인증수</th></tr>
                  </thead>
                  <tbody id="roomCertTable"></tbody>
                </table>
              </div>
            </div>
            <div>
              <h4>진도율 상승 고객 (4주 기준)</h4>
              <div style="max-height: 400px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr><th>고객명</th><th>현재 진도율</th><th>상승폭</th></tr>
                  </thead>
                  <tbody id="roomProgressTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 기간 조회 -->
      <div class="card">
        <h3>기간 조회</h3>
        <div class="search-filters">
          <label>조회 시작일: <input type="date" id="periodStartDate" class="filter-input"></label>
          <label>조회 종료일: <input type="date" id="periodEndDate" class="filter-input"></label>
          <button id="applyPeriodFilter" class="btn primary">조회</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
          <div>
            <h4>인증 현황 (기간 내 주간 평균)</h4>
            <div style="max-height: 400px; overflow-y: auto;">
              <table>
                <thead>
                  <tr><th>단톡방</th><th>고객명</th><th>주간 평균 인증수</th></tr>
                </thead>
                <tbody id="periodCertTable"></tbody>
              </table>
            </div>
          </div>
          <div>
            <h4>진도율 현황 (기간 내 상승)</h4>
            <div style="max-height: 400px; overflow-y: auto;">
              <table>
                <thead>
                  <tr><th>단톡방</th><th>고객명</th><th>현재 진도율</th><th>상승폭</th></tr>
                </thead>
                <tbody id="periodProgressTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 개인 조회 탭 -->
    <div id="tabPersonal" style="display:none;">
      <!-- 기존 필터 -->
      <div class="card">
        <div class="row">
          <div class="field">
            <label class="muted" for="courseSelect">과정명</label>
            <select id="courseSelect" class="input">
              <option value="">과정 명을 선택하세요 ▼</option>
            </select>
          </div>
          <div class="field">
            <label class="muted" for="roomSelect">단톡방 이름</label>
            <select id="roomSelect" class="input">
              <option value="">단톡방 명을 선택하세요 ▼</option>
            </select>
          </div>
          <div class="field">
            <label class="muted" for="nickInput">닉네임</label>
            <input id="nickInput" type="search" class="input" list="nickList" placeholder="닉네임 선택">
            <datalist id="nickList"></datalist>
          </div>
          <div class="field">
            <button id="applyBtn" type="button" class="btn primary">적용</button>
          </div>
        </div>
      </div>

      <!-- 안내 -->
      <p id="helpNote" class="muted" style="margin:5px 0 11px 0;">
        * 조회가 안되시는 분은<br>
        1. 닉네임 시트의 닉네임을 쓰시고 계시는지, <br>
        2. 닉네임 시트의 이메일과 스터디언 클래스 계정의 이메일이 일치하는지 확인해주세요:)<br>
        ※ 문의 : <a href="https://studianclass.channel.io" target="_blank" rel="noopener noreferrer">studianclass.channel.io</a>
      </p>

      <!-- 차트 -->
      <div class="card">
        <h3 id="chartTitle">진도율(%)</h3>
        <div class="chart-box"><canvas id="progressChart"></canvas></div>
      </div>

<!-- 달력 -->
      <div class="card">
        <h3 id="calendarCardTitle">학습 활동 달력</h3>
        
        <!-- 달력 상단 정보 -->
        <div id="calendarSummary" class="calendar-summary" style="display: none;">
          <div class="summary-item">
            <span class="summary-label">현재 진도율:</span>
            <span id="currentProgress" class="summary-value">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">총 진도율 상승:</span>
            <span id="totalProgressGain" class="summary-value">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">주간 평균 인증:</span>
            <span id="weeklyAvgCerts" class="summary-value">-</span>
          </div>
        </div>
        
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="calendar-nav-btn" id="prevMonthBtn">‹</button>
            <div class="calendar-title" id="calendarTitle">2025년 6월</div>
            <button class="calendar-nav-btn" id="nextMonthBtn">›</button>
          </div>
          
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <div class="calendar-weekday">월</div>
              <div class="calendar-weekday">화</div>
              <div class="calendar-weekday">수</div>
              <div class="calendar-weekday">목</div>
              <div class="calendar-weekday">금</div>
              <div class="calendar-weekday">토</div>
              <div class="calendar-weekday">일</div>
            </div>
            <div id="calendarDays"></div>
          </div>
          
          <div class="calendar-legend">
            <div class="legend-item">
              <div class="cert-indicator" style="margin: 0;">인증</div>
              <span>해당 날짜에 학습 인증을 완료한 경우</span>
            </div>
            <div class="legend-item">
              <div class="progress-indicator" style="margin: 0;">+5</div>
              <span>해당 날짜에 진도율이 1% 이상 상승한 경우 (상승량 표시)</span>
            </div>
            <div id="calendarStatus" class="muted" style="margin-left: auto; font-size: 12px;"></div>
          </div>
        </div>
      </div>    

      <!-- 인증표 -->
      <div class="card">
        <h3>인증 현황 (상위 20명)</h3>
        <div class="muted" id="certCount"></div>
        <table>
          <thead>
            <tr><th>순위</th><th>이름</th><th>인증일수</th><th>주간 평균</th></tr>
          </thead>
          <tbody id="certTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="./js/app.js"></script>
</body>
</html>
